- name: ensure user
  become: true
  ansible.builtin.user:
    name: node_exporter
    system: true
    shell: /usr/sbin/nologin
    create_home: false

- name: arch map
  ansible.builtin.set_fact:
    arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armv7
      armv6l: armv6
      i386: 386
      ppc64le: ppc64le
      s390x: s390x
      riscv64: riscv64

- name: set goarch
  ansible.builtin.set_fact:
    goarch: "{{ arch_map[ansible_architecture] | default('') }}"
  failed_when: goarch == ""

- name: resolve latest
  when: node_exporter_latest | bool
  ansible.builtin.uri:
    url: https://api.github.com/repos/prometheus/node_exporter/releases/latest
    return_content: true
  register: latest_release

- name: set version
  ansible.builtin.set_fact:
    resolved_version: "{{ (node_exporter_latest | bool) | ternary(latest_release.json.tag_name, node_exporter_version) }}"

- name: set paths (part 1)
  ansible.builtin.set_fact:
    tarball: "node_exporter-{{ resolved_version | regex_replace('^v','') }}.linux-{{ goarch }}.tar.gz"
    base_url: "https://github.com/prometheus/node_exporter/releases/download/{{ resolved_version }}"
    dest_dir: "/usr/local/bin"

- name: set paths (part 2)
  ansible.builtin.set_fact:
    tar_url: "{{ base_url }}/{{ tarball }}"
    sha_url: "{{ base_url }}/sha256sums.txt"

- name: fetch sha file
  ansible.builtin.uri:
    url: "{{ sha_url }}"
    return_content: true
  register: _sha

- name: split sha lines
  ansible.builtin.set_fact:
    _sha_lines: "{{ _sha.content.splitlines() }}"

- name: pick checksum line
  ansible.builtin.set_fact:
    _sha_line: "{{ item }}"
  loop: "{{ _sha_lines }}"
  when: item.endswith(' ' ~ tarball)
  run_once: true

- name: fail if checksum not found
  ansible.builtin.fail:
    msg: "checksum line not found for {{ tarball }}"
  when: _sha_line is not defined or _sha_line | length == 0

- name: set checksum value
  ansible.builtin.set_fact:
    tar_sha256: "{{ _sha_line.split()[0] }}"

- name: ensure dest dir
  become: true
  ansible.builtin.file:
    path: "{{ dest_dir }}"
    state: directory
    mode: "0755"

- name: download tarball
  become: true
  ansible.builtin.get_url:
    url: "{{ tar_url }}"
    dest: "/tmp/{{ tarball }}"
    checksum: "sha256:{{ tar_sha256 }}"
    mode: "0644"

- name: unarchive
  become: true
  ansible.builtin.unarchive:
    src: "/tmp/{{ tarball }}"
    dest: /tmp
    remote_src: true

- name: install binary
  become: true
  ansible.builtin.copy:
    src: "/tmp/node_exporter-{{ resolved_version | regex_replace('^v','') }}.linux-{{ goarch }}/node_exporter"
    dest: "/usr/local/bin/node_exporter"
    mode: "0755"
    owner: root
    group: root
    remote_src: true
  notify: restart node_exporter

- name: unit file
  become: true
  ansible.builtin.template:
    src: node_exporter.service.j2
    dest: /etc/systemd/system/node_exporter.service
    mode: "0644"
  notify: restart node_exporter

- name: daemon reload
  become: true
  ansible.builtin.systemd:
    daemon_reload: true

- name: enable service
  become: true
  ansible.builtin.systemd:
    name: node_exporter
    enabled: true

- name: ensure running
  become: true
  ansible.builtin.systemd:
    name: node_exporter
    state: started

- name: cleanup temp files
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/{{ tarball }}"
    - "/tmp/node_exporter-{{ resolved_version | regex_replace('^v','') }}.linux-{{ goarch }}"
