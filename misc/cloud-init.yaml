#cloud-config
users:
  - name: rus
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    shell: /bin/bash
    passwd: $2y$05$WckQtamHibLAtYwZ6zY1xOeK3nrlw6RPULbrWTjfNuw.I7h0Qzs2W
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMJ1HLduJD+xCSVOnF8b9DrLp/DwHx9bxsoyGWdduJid ruslanguns@gmail.com | nixos-wsl2
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKJr3PUC/j2x4C39GDBNLXPWebRiLf6AHY3VJ/4cTb0P wsl.rusodev-01-12-2024
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINuamihqruTuItFfvmn7NRoYSGpDQrDpzo02ezd9VHRj ruslanguns@gmail.com | (desktop-wsl-01) NixOS
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMJ1HLduJD+xCSVOnF8b9DrLp/DwHx9bxsoyGWdduJid ruslanguns@gmail.com | (huawei-wsl-01) NixOs

package_update: true
package_upgrade: true

packages:
  - curl
  # - fail2ban
  # - ufw

write_files:
  - path: /etc/motd
    content: |
      ██████╗ ██╗   ██╗███████╗ ██████╗    ██████╗ ███████╗██╗   ██╗
      ██╔══██╗██║   ██║██╔════╝██╔═══██╗   ██╔══██╗██╔════╝██║   ██║
      ██████╔╝██║   ██║███████╗██║   ██║   ██║  ██║█████╗  ██║   ██║
      ██╔══██╗██║   ██║╚════██║██║   ██║   ██║  ██║██╔══╝  ╚██╗ ██╔╝
      ██║  ██║╚██████╔╝███████║╚██████╔╝██╗██████╔╝███████╗ ╚████╔╝
      ╚═╝  ╚═╝ ╚═════╝ ╚══════╝ ╚═════╝ ╚═╝╚═════╝ ╚══════╝  ╚═══╝
                    @ruslangonzalez | @ruslanguns

      Welcome, Rus! 🚀

runcmd:
  # - systemctl enable fail2ban
  # - ufw allow 2222/tcp
  # - ufw --force enable
  # - printf"[sshd]\nenabled = true\nbanaction = iptables-multiport\nport = 2222" > /etc/fail2ban/jail.local
  - sed -i -e '/^\(#\|\)Port/s/^.*$/Port 2222/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)PasswordAuthentication/s/^.*$/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)KbdInteractiveAuthentication/s/^.*$/KbdInteractiveAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)ChallengeResponseAuthentication/s/^.*$/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)MaxAuthTries/s/^.*$/MaxAuthTries 2/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AllowTcpForwarding/s/^.*$/AllowTcpForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)X11Forwarding/s/^.*$/X11Forwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AllowAgentForwarding/s/^.*$/AllowAgentForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AuthorizedKeysFile/s/^.*$/AuthorizedKeysFile .ssh\/authorized_keys/' /etc/ssh/sshd_config
  - sed -i '$a AllowUsers rus' /etc/ssh/sshd_config
  - curl -fsSL https://tailscale.com/install.sh | sh
  - reboot
